name: Demo Deploy (after CI-CD)

on:
  workflow_run:
    workflows: ["CI-CD"]
    types: [completed]
  workflow_dispatch:

concurrency:
  group: demo-deploy-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

jobs:
  deploy:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      (github.event.workflow_run.event == 'pull_request' || github.event.workflow_run.event == 'push')
    runs-on: ubuntu-latest

    steps:
      - name: Compute deploy target
        shell: bash
        run: |
          set -euo pipefail

          BRANCH="${{ github.event.workflow_run.head_branch }}"
          SHA="${{ github.event.workflow_run.head_sha }}"
          SHORT="${SHA:0:7}"
          VERSION="${BRANCH}@${SHORT}"

          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "RUN_URL=https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> "$GITHUB_ENV"

          if [ "${{ github.event.workflow_run.event }}" = "pull_request" ]; then
            echo "ENVIRONMENT=pr" >> "$GITHUB_ENV"
            echo "TARGET_DIR=/opt/football-metrics-pr" >> "$GITHUB_ENV"
            echo "ENV_FILE=.env.demo.pr" >> "$GITHUB_ENV"
            echo "FRONTEND_URL=${{ vars.FRONTEND_URL_PR }}" >> "$GITHUB_ENV"
          else
            # push: only deploy main/master
            if [ "$BRANCH" != "master" ] && [ "$BRANCH" != "main" ]; then
              echo "Push branch '$BRANCH' is not main/master -> skip deploy."
              echo "ENVIRONMENT=skip" >> "$GITHUB_ENV"
              exit 0
            fi

            echo "ENVIRONMENT=master" >> "$GITHUB_ENV"
            echo "TARGET_DIR=/opt/football-metrics-master" >> "$GITHUB_ENV"
            echo "ENV_FILE=.env.demo.master" >> "$GITHUB_ENV"
            echo "FRONTEND_URL=${{ vars.FRONTEND_URL_MASTER }}" >> "$GITHUB_ENV"
          fi

      - name: Deploy via SSH
        if: env.ENVIRONMENT != 'skip'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEMO_SSH_HOST }}
          username: ${{ secrets.DEMO_SSH_USER }}
          key: ${{ secrets.DEMO_SSH_PRIVATE_KEY }}
          port: ${{ secrets.DEMO_SSH_PORT || '22' }}
          script_stop: true
          script: |
            set -euo pipefail

            echo "ENV:     $ENVIRONMENT"
            echo "BRANCH:  $BRANCH"
            echo "VERSION: $VERSION"
            echo "DIR:     $TARGET_DIR"

            sudo mkdir -p "$TARGET_DIR"
            sudo chown -R "$USER":"$USER" "$TARGET_DIR"

            if [ ! -d "$TARGET_DIR/.git" ]; then
              git clone git@github.com:${{ github.repository }}.git "$TARGET_DIR"
            fi

            cd "$TARGET_DIR"

            git fetch origin
            git checkout "$BRANCH" || git checkout -b "$BRANCH" "origin/$BRANCH"
            git reset --hard "origin/$BRANCH"

            VITE_APP_VERSION="$VERSION" APP_VERSION="$VERSION" \
              docker compose --env-file "$ENV_FILE" up -d --build --remove-orphans

            docker compose --env-file "$ENV_FILE" ps

      - name: Notify via ntfy
        if: always()
        continue-on-error: true
        shell: bash
        env:
          NTFY_URL: ${{ secrets.NTFY_URL }}
          BRANCH: ${{ env.BRANCH }}
          VERSION: ${{ env.VERSION }}
          RUN_URL: ${{ env.RUN_URL }}
          FRONTEND_URL: ${{ env.FRONTEND_URL }}
        run: |
          set -euo pipefail

          STATUS="${{ job.status }}"
          TITLE="football-metrics deploy: ${ENVIRONMENT:-unknown} (${STATUS})"

          # Build the message cleanly
          MSG=$(printf 'Branch: %s\nVersion: %s\nRun: %s' \
            "${BRANCH:-n/a}" "${VERSION:-n/a}" "${RUN_URL:-n/a}")

          if [ -n "${FRONTEND_URL:-}" ]; then
            MSG="${MSG}\nURL: ${FRONTEND_URL}"
          fi

          if [ -n "${NTFY_URL:-}" ]; then
            curl -sS -X POST "$NTFY_URL" -H "Title: $TITLE" -d "$MSG" >/dev/null
          else
            echo "NTFY_URL not set; skipping."
          fi
